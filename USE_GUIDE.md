# 使用指南

本文档详细介绍了 Vless-all-In-One 多协议代理一键部署脚本的所有功能和操作步骤。

---

## 目录

1. [快速开始](#快速开始)
2. [协议安装](#协议安装)
3. [用户管理](#用户管理)
4. [分流功能](#分流功能)
5. [链式代理](#链式代理)
6. [负载均衡](#负载均衡)
7. [多IP入出站配置](#多ip入出站配置)
8. [CF Tunnel(Argo)](#cf-tunnelargo)
9. [订阅服务](#订阅服务)
10. [端口复用](#端口复用)
11. [端口跳跃](#端口跳跃)
12. [BBR 优化](#bbr-优化)
13. [配置管理](#配置管理)
14. [常见问题](#常见问题)

---

## 快速开始

### 系统要求

| 项目 | 要求 |
|------|------|
| 系统 | Debian 10+, Ubuntu 20.04+, CentOS 7+, Alpine 3.15+ |
| 架构 | x86_64, aarch64 |
| 内存 | 最低 128MB |
| 网络 | 公网 IP (或使用 CF Tunnel) |

### 安装脚本

```bash
wget -O vless-server.sh https://raw.githubusercontent.com/Chil30/vless-all-in-one/main/vless-server.sh && bash vless-server.sh
```

### 运行脚本

安装后可通过快捷命令直接运行：
```bash
vless
```

### 主菜单概览

```
═════════════════════════════════════════════
      多协议代理 一键部署  [服务端]
      作者: Chil30  快捷命令: vless
═════════════════════════════════════════════
  服务端管理
  系统: ubuntu | 架构: Xray+Sing-box 双核
  状态: ● 运行中
  协议: VLESS+Reality, VLESS-WS, Hysteria2
  端口: 443, 10999
  分流: 3条规则→Japan+04+Amazon
─────────────────────────────────────────────
  1) 安装新协议 (多协议共存)
  2) 核心版本管理 (Xray/Sing-box)
  3) 卸载指定协议
  4) 用户管理 (多用户/流量/通知)
  ───────────────────────────────────────────
  5) 查看协议配置
  6) 订阅服务管理
  7) 管理协议服务
  8) 分流管理
  9) CF Tunnel(Argo)
  ───────────────────────────────────────────
 10) BBR 网络优化
 11) 查看运行日志
  u) 检查脚本更新
  0) 退出
─────────────────────────────────────────────
```

---

## 协议安装

### 支持的 14 种协议

| 协议 | 核心 | 端口 | 特点 | 适用场景 |
|------|------|------|------|----------|
| VLESS + Reality | Xray | 443 | 🌟 抗封锁强，免证书 | 首选推荐 |
| VLESS + XHTTP | Xray | 443 | 多路复用，高并发 | 高并发场景 |
| VLESS + WS | Xray | 443 | CDN 友好 | 过 CDN |
| VMess + WS | Xray | 443 | 兼容性好 | 老客户端 |
| VLESS-Vision | Xray | 443 | TLS 主协议 | 端口复用 |
| Trojan | Xray | 443 | HTTPS 伪装 | 端口复用 |
| SOCKS5 | Xray | 自定义 | 通用协议 | 本地代理 |
| SS2022 | Xray | 自定义 | AEAD 2022 | 兼容需求 |
| Hysteria2 | Sing-box | UDP | 基于 QUIC，速度快 | UDP 加速 |
| TUIC v5 | Sing-box | UDP | 低延迟 | 游戏加速 |
| Snell v4/v5 | 独立 | 自定义 | Surge 专用 | iOS 用户 |
| AnyTLS | 独立 | 443 | 抗审查 | 特殊环境 |
| NaïveProxy | Caddy | 443 | HTTP/2 伪装 | 深度伪装 |

### 安装步骤

1. **进入安装菜单**
   ```bash
   vless → 1) 安装新协议
   ```

2. **选择协议类型**
   - 根据需求选择对应协议
   - 推荐首选 VLESS+Reality

3. **配置端口**
   - 回车使用默认端口
   - 或输入自定义端口

4. **等待安装**
   - 自动下载核心
   - 自动配置证书（如需要）
   - 自动启动服务

5. **获取配置**
   - 分享链接
   - 二维码
   - 订阅地址

### 随机 SNI 功能

安装 VLESS+Reality 时，脚本会自动随机选择主流网站作为 SNI 伪装：

| 可选 SNI |
|----------|
| azure.microsoft.com |
| www.microsoft.com |
| www.cloudflare.com |
| www.apple.com |
| cdn.jsdelivr.net |
| www.akamai.com |

**好处**：每次安装使用不同的 SNI，减少特征识别。

### 多协议共存

脚本支持同时安装多个协议：
- VLESS+Reality + Hysteria2 (TCP + UDP 双栈)
- VLESS-Vision + VLESS-WS (端口复用)
- 任意组合...

```
已安装协议:
  • VLESS+Reality (443)
  • Hysteria2 (15999)
  • TUIC v5 (16999)
```

###  XHTTP TLS+CDN 模式

XHTTP TLS+CDN 模式是专为 **IP 被墙场景** 设计的解决方案，流量通过 Cloudflare CDN 代理，隐藏服务器真实 IP。

#### 工作原理

```
客户端 → Cloudflare CDN (隐藏服务器IP) → Nginx (TLS终结) → Xray (XHTTP)
```

#### 前置要求

1. **托管在 Cloudflare 的域名**（开启小云朵代理）
2. **域名已解析到服务器 IP**
3. **Cloudflare SSL/TLS 设置为 Full 或 Full (Strict)**

#### 安装步骤

1. 选择 `VLESS+XHTTP` 协议
2. 当系统询问"请选择 XHTTP 模式"时，选择 `2) TLS+CDN`
3. 输入已在 Cloudflare 配置的域名
4. 系统自动配置 Nginx 反代和 Xray

#### 客户端兼容性

| 平台 | 客户端 | XHTTP支持 |
|------|--------|:---------:|
| Android | V2rayNG 1.8.31+ | ✅ |
| Android | NekoBox | ✅ |
| iOS | Streisand | ✅ |
| iOS | Shadowrocket | ❌ |
| Windows | V2rayN (Xray核心) | ✅ |

> 💡 iOS 用户如需 CDN 支持，建议改用 **VLESS+WS+TLS** 协议。

---

## 用户管理

### 功能入口

```bash
vless → 4) 用户管理
```

### 用户管理菜单

```
═════════════════════════════════════════════
  用户管理
═════════════════════════════════════════════
  已安装协议:
  • VLESS-REALITY: 5 用户
  • VLESS-WS: 1 用户
─────────────────────────────────────────────
  1) 查看用户列表
  2) 添加用户
  3) 删除用户
  4) 设置用户配额
  5) 重置用户流量
  6) 启用/禁用用户
  r) 修改用户路由
  s) 查看用户分享链接
─────────────────────────────────────────────
  7) 实时流量统计
  8) 同步流量数据
  9) 流量统计设置
─────────────────────────────────────────────
  t) TG 通知配置
  0) 返回
─────────────────────────────────────────────
```

### 添加用户

1. 选择 `2) 添加用户`
2. 选择协议
3. 输入用户名（支持中文）
4. 可选：设置流量配额（GB）
5. 用户自动生成 UUID 并添加到配置

**示例**：
```
选择协议: VLESS-REALITY
输入用户名: 张三
设置流量配额 (GB，0=不限): 100

✓ 用户添加成功
  用户名: 张三
  UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  配额: 100 GB
```

### 查看用户列表

```
═════════════════════════════════════════════
  VLESS-REALITY 用户列表
─────────────────────────────────────────────
  [1] 默认用户
      UUID: xxxxxxxx-xxxx-xxxx-xxxx
      状态: 启用
      流量: 12.5 GB / 无限制
  [2] 张三
      UUID: yyyyyyyy-yyyy-yyyy-yyyy
      状态: 启用
      流量: 45.2 GB / 100 GB
  [3] 李四
      UUID: zzzzzzzz-zzzz-zzzz-zzzz
      状态: 禁用
      流量: 102.3 GB / 100 GB (超限)
─────────────────────────────────────────────
```

### 查看用户分享链接

1. 选择 `s) 查看用户分享链接`
2. 选择协议
3. 选择用户或按 `a` 一键展示所有链接
4. 显示该用户的专属分享链接和二维码

**示例输出**：
```
═════════════════════════════════════════════
  张三 - VLESS-REALITY 分享链接
─────────────────────────────────────────────
  分享链接:
  vless://yyyyyyyy-yyyy-yyyy@1.2.3.4:443?...

  二维码:
  ████████████████████
  ██  ██  ██  ██  ██
  ██  ██  ██  ██  ██
  ████████████████████
```

### 流量统计

| 功能 | 说明 |
|------|------|
| 实时流量统计 | 显示当前所有用户的上行/下行/总流量 |
| 同步流量数据 | 手动同步 Xray 流量数据到数据库 |
| 流量统计设置 | 配置自动同步间隔（默认 5 分钟） |

### 流量配额管理

1. 选择 `4) 设置用户配额`
2. 选择协议和用户
3. 输入配额（GB，0 表示无限制）

**超限处理**：
- 用户流量超限后自动禁用
- 可手动重置流量或增加配额
- 重置后自动重新启用

### TG 通知配置

1. 选择 `t) TG 通知配置`
2. 输入 Bot Token 和 Chat ID
3. 发送测试消息确认

**通知类型**：
- 用户流量超限通知
- 每日流量报告（可选）
- 用户添加/删除通知

###  用户级路由配置

用户级路由允许同端口不同用户使用不同的出站节点，优先于全局分流规则。

#### 功能说明

| 特性 | 说明 |
|------|------|
| 独立配置 | 每个用户可配置专属出站路由 |
| 优先级高 | 用户级路由优先于全局分流规则 |
| 向后兼容 | 未配置路由的用户使用全局规则 |
| 实时生效 | 修改后自动重建配置 |

#### 支持的路由类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 全局规则 | 使用全局分流规则 | (默认) |
| 直连 | 使用本机 IP 直连 | direct |
| WARP | 通过 Cloudflare WARP | warp |
| 链式代理 | 通过落地节点 | Japan+04 |
| 负载均衡 | 通过负载均衡组 | 日本节点组 |

#### 添加用户时配置路由

1. 进入 `用户管理 → 添加用户`
2. 输入用户名和配额
3. 当提示"是否为此用户配置专属路由?"时选择 `Y`
4. 选择路由类型

```
─────────────────────────────────────────────
  是否为此用户配置专属路由? [y/N]: y

  选择用户路由
  用户级路由优先于全局分流规则
─────────────────────────────────────────────
  1) 使用全局规则 (默认)
  2) 直连
  3) WARP 代理
  ──链式代理节点──
  4) 链路→Japan+04
  5) 链路→Singapore+02
  ──负载均衡组──
  6) 负载→日本节点组
  0) 取消
─────────────────────────────────────────────
  请选择 [0-6]: 4
```

#### 修改现有用户路由

1. 进入 `用户管理 → 修改用户路由 (r)`
2. 选择协议
3. 选择用户
4. 选择新的路由配置

```
─────────────────────────────────────────────
  修改用户路由 - VLESS-REALITY
─────────────────────────────────────────────
  1) user1 (当前: 全局规则)
  2) user2 (当前: 直连)
  3) user3 (当前: 链路→Japan+04)
  0) 返回
─────────────────────────────────────────────
  选择用户 [0-3]: 2
```

#### 查看用户路由

在用户列表中可以看到每个用户的路由配置：

```
═════════════════════════════════════════════
  VLESS-REALITY 用户列表
═════════════════════════════════════════════
  用户名     已用      配额       使用率   状态  路由
─────────────────────────────────────────────
  user1      1.5 GB    无限       -        ●     全局规则
  user2      12.3 GB   100 GB     12%      ●     直连
  user3      45.2 GB   50 GB      90%      ●     链路→Japan
─────────────────────────────────────────────
```

#### 使用场景

**场景1：VIP用户使用专属落地**
```
普通用户 → 全局规则 (WARP)
VIP用户 → 链路→Japan+04 (高速节点)
```

**场景2：按需解锁流媒体**
```
用户A → 直连 (本机解锁Netflix)
用户B → 链路→Singapore (解锁Disney+)
用户C → WARP (通用需求)
```

**场景3：负载均衡**
```
高流量用户 → 负载→日本节点组 (多节点分担)
```

---

## 分流功能

### 核心概念

分流功能让你可以为不同网站配置不同的代理出口：

```
用户请求 → VPS (入口)
              │
              ├─── Netflix ────→ 直连 (本机IPv6) ────→ Netflix
              │
              ├─── ChatGPT ────→ 🇸🇬 新加坡节点 ────→ OpenAI
              │
              ├─── TikTok ─────→ 🇯🇵 日本节点 ─────→ TikTok
              │
              └─── 其他 ───────→ 直连出口 ───────→ 目标网站
```

### 四种出口类型

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **直连** | 使用本机 IP 出口 | 服务器本机已解锁的流媒体 |
| **WARP** | Cloudflare 免费出口 | 免费解锁、隐藏 IP |
| **链式代理** | 导入已解锁的节点 | 用自己的解锁机落地 |
| **双层链式** | WARP → 落地节点 | 隐藏真实 IP + 解锁 |

### 分流管理菜单

```bash
vless → 8) 分流管理
```

```
═════════════════════════════════════════════
  分流管理
─────────────────────────────────────────────
  出口状态
─────────────────────────────────────────────
  直连: 自动
  WARP: ● 已启用 (WGCF模式)
  代理: ● 38 个节点
─────────────────────────────────────────────
  分流规则
─────────────────────────────────────────────
  ● TikTok → Japan+04+Amazon
  ● OpenAI → Singapore+02+Amazon
  ● Telegram → Hong+Kong+04
─────────────────────────────────────────────
  1) WARP 管理
  2) 链式代理
  3) 快速配置代理出口
  4) 配置分流规则
  5) 直连出口设置
  6) 测试分流效果
  7) 查看当前配置
  0) 返回主菜单
─────────────────────────────────────────────
```

### 分流管理完整功能说明

分流管理菜单包含以下功能：

| 选项 | 功能 | 说明 |
|------|------|------|
| 1) WARP 管理 | 配置 Cloudflare WARP | 作为免费出口使用 |
| 2) 链式代理 | 管理落地节点 | 导入订阅、添加节点 |
| 3) 快速配置代理出口 | 一键配置全局出口 | 所有流量使用同一出口 |
| 4) 配置分流规则 | 精细化分流配置 | 按网站配置不同出口 |
| 5) 直连出口设置 | 配置直连IP版本 | IPv4/IPv6偏好 |
| 6) 测试分流效果 | 验证分流是否生效 | 显示调试信息 |
| 7) 查看当前配置 | 查看所有规则 | 完整配置一览 |
| 8) 删除分流规则 | 删除单条规则 | 精确管理 |
| 9) 清空所有规则 | 重置分流配置 | 恢复默认 |
| 10) 一键导入 Alice | 导入家宽线路 | 支持负载均衡 |
| 11) 多IP入出站配置 | 多IP服务器配置 | 按IP路由出站 |

### 配置分流规则（详细步骤）

#### 第1步：进入分流规则配置

```bash
vless → 8) 分流管理 → 4) 配置分流规则
```

#### 第2步：选择操作

```
═════════════════════════════════════════════
  配置分流规则
─────────────────────────────────────────────
  当前规则:
    ● OpenAI → WARP [IPv4优先]
    ● TikTok → Japan+04 [链式]
─────────────────────────────────────────────
  1) 添加分流规则
  2) 删除分流规则
  3) 清空所有规则
  0) 返回
─────────────────────────────────────────────
  请选择: 1
```

#### 第3步：选择规则类型

```
═════════════════════════════════════════════
  添加分流规则
─────────────────────────────────────────────
  选择规则类型:
  
  a) 预设规则 (geosite) - 推荐
  b) 广告屏蔽 (geosite)
  c) 自定义规则 (域名/IP)
  d) 全局出口 (所有流量)
  0) 返回
─────────────────────────────────────────────
  请选择: a
```

#### 第4步A：选择预设规则

```
═════════════════════════════════════════════
  预设规则列表
─────────────────────────────────────────────
  1) AI服务(国际) - 包含所有主流AI服务
  2) OpenAI/ChatGPT - ChatGPT、Sora等
  3) Netflix - Netflix流媒体
  4) Disney+ - Disney+流媒体
  5) MyTVSuper - 香港TVB
  6) YouTube - YouTube视频
  7) Spotify - Spotify音乐
  8) TikTok - TikTok短视频
  9) Telegram - Telegram通讯
 10) Google - Google全系服务
  0) 返回
─────────────────────────────────────────────
  请选择: 2
```

#### 第4步B：如果选择自定义规则

```
═════════════════════════════════════════════
  自定义规则
─────────────────────────────────────────────
  输入域名或IP地址:
  
  支持的格式:
  • 单个域名: example.com
  • 通配符: *.example.com
  • 完整域名: domain:example.com
  • geosite规则: geosite:netflix
  • 单个IP: 1.2.3.4
  • CIDR: 192.168.0.0/24
  • 多个用逗号分隔
  
  > anthropic.com,claude.ai,gemini.google.com
─────────────────────────────────────────────
```

#### 第5步：选择出口

选择规则后，选择该规则使用的出口：

```
═════════════════════════════════════════════
  选择出口
─────────────────────────────────────────────
  ▸ 检测 38 个节点延迟中...
  
  TCP延迟排序 (从低到高):
─────────────────────────────────────────────
  1) [直连] DIRECT
  2) [WARP] Cloudflare WARP
  3) [8ms] 🇭🇰Hong+Kong+04 (vless)
  4) [9ms] 🇯🇵Japan+04+Amazon (vless)
  5) [12ms] 🇸🇬Singapore+02+Amazon (vless)
  6) [balancer] 日本节点组 (最低延迟, 5节点)
  0) 返回
─────────────────────────────────────────────
  选择出口 [1]: 4
```

#### 第6步：选择IP版本（可选）

```
═════════════════════════════════════════════
  IP版本选择
─────────────────────────────────────────────
  选择出站IP版本偏好:
  
  1) IPv4优先 (默认)
  2) IPv6优先
  3) 仅IPv4
  4) 仅IPv6
  5) 自动 (AsIs)
  0) 返回
─────────────────────────────────────────────
  请选择 [1]: 1
```

**各选项说明**：

| 选项 | 说明 | 适用场景 |
|------|------|----------|
| IPv4优先 | 优先使用IPv4，无则IPv6 | 默认推荐 |
| IPv6优先 | 优先使用IPv6，无则IPv4 | IPv6资源优先 |
| 仅IPv4 | 只使用IPv4 | 确保使用IPv4出口 |
| 仅IPv6 | 只使用IPv6 | Netflix等需IPv6场景 |
| 自动 | 不做处理，按原始请求 | 特殊需求 |

#### 第7步：确认添加

```
═════════════════════════════════════════════
  规则添加确认
─────────────────────────────────────────────
  规则类型: OpenAI/ChatGPT
  匹配: geosite:openai
  出口: Japan+04+Amazon
  IP版本: IPv4优先
  
  确认添加? [Y/n]: y
  
  ✓ 规则添加成功
  ▸ 重新生成配置...
  ▸ 重启 Xray...
  ✓ 配置已生效
─────────────────────────────────────────────
```

### 删除分流规则

选择 `2) 删除分流规则`：

```
═════════════════════════════════════════════
  删除分流规则
─────────────────────────────────────────────
  当前规则:
  
  1) OpenAI/ChatGPT → Japan+04+Amazon [IPv4优先]
  2) TikTok → Hong+Kong+04 [IPv4优先]
  3) Netflix → 直连 [仅IPv6]
  4) 全局 → WARP [IPv4优先]
─────────────────────────────────────────────
  输入序号删除 (0 返回): 2
  
  ✓ 规则已删除
  ▸ 重新生成配置...
  ✓ 配置已生效
─────────────────────────────────────────────
```

### 测试分流效果

选择 `6) 测试分流效果`：

```
═════════════════════════════════════════════
  测试分流效果
─────────────────────────────────────────────
  当前出口状态:
    直连: 可用
    WARP: 已连接 (WGCF模式)
    代理: 38 个节点
─────────────────────────────────────────────
  已配置的分流规则:
    • OpenAI → Japan+04+Amazon
    • TikTok → Hong+Kong+04
    • Netflix → 直连 (IPv6)
─────────────────────────────────────────────
  
  如何验证分流是否生效:
  • 访问 https://chat.openai.com 应显示日本IP
  • 访问 https://www.netflix.com 应显示本机IPv6
  • 手机访问 https://ip.sb 查看出口 IP

  调试命令 (Xray):
  • 检查配置语法: xray run -test -c /etc/vless-reality/config.json
  • 开启调试日志: 修改 loglevel 为 debug
─────────────────────────────────────────────
```

### 快速配置代理出口

这是一个一键配置功能，将所有流量通过指定出口：

```
═════════════════════════════════════════════
  快速配置代理出口
─────────────────────────────────────────────
  此功能将创建一条"全局出口"规则
  所有流量都将通过您选择的出口
  
  ▸ 检测节点延迟中...
─────────────────────────────────────────────
  选择全局出口:
  
  1) [直连] 直接连接
  2) [WARP] Cloudflare WARP
  3) [9ms] Japan+04+Amazon
  ...
─────────────────────────────────────────────
  请选择: 3
  
  ✓ 已设置全局出口: Japan+04+Amazon
  ▸ 所有流量将通过此节点出站
─────────────────────────────────────────────
```

### 直连出口设置

配置默认直连出口使用的IP版本：

```
═════════════════════════════════════════════
  直连出口设置
─────────────────────────────────────────────
  设置直连流量使用的 IP 版本
  适用于双栈服务器选择出口 IP
  
  当前设置: 自动 (AsIs)
  
  1) 自动 (AsIs) - 不强制IP版本
  2) IPv4 优先
  3) IPv6 优先
  4) 仅 IPv4
  5) 仅 IPv6
  0) 返回
─────────────────────────────────────────────
  请选择: 5
  
  ✓ 直连出口已设置为: 仅IPv6
  ▸ 重新生成配置...
  ✓ 配置已生效
─────────────────────────────────────────────
```

### 分流配置最佳实践

**场景1：解锁 Netflix（本机IPv6）**
```
规则: Netflix
出口: 直连
IP版本: 仅IPv6
```

**场景2：ChatGPT 使用日本节点**
```
规则: OpenAI/ChatGPT
出口: Japan+04+Amazon (或日本节点组)
IP版本: IPv4优先
```

**场景3：屏蔽广告**
```
规则: 广告屏蔽
出口: block (拦截)
```

**场景4：其他流量走WARP**
```
规则: 全局
出口: WARP
IP版本: IPv4优先
```

### 配置分流规则

1. 选择 `4) 配置分流规则`
2. 选择 `1) 添加分流规则`
3. 选择规则类型：
   - `a) 预设规则 (geosite)` - OpenAI、Netflix 等
   - `b) 广告屏蔽 (geosite)`
   - `c) 自定义规则`
4. 选择出口

### 预设规则列表

| 规则 | geosite 规则库 | 说明 |
|------|---------------|------|
| OpenAI/ChatGPT | `geosite:openai` | ChatGPT、Sora 等 AI 服务 |
| Netflix | `geosite:netflix` | Netflix 流媒体 |
| Disney+ | `geosite:disney` | Disney+ 流媒体 |
| YouTube | `geosite:youtube` | YouTube 视频 |
| Spotify | `geosite:spotify` | Spotify 音乐 |
| TikTok | `geosite:tiktok` | TikTok 短视频 |
| Telegram | `geosite:telegram` | Telegram 通讯 |
| Google | `geosite:google` | Google 全系服务 |
| 广告屏蔽 | `geosite:category-ads-all` | 广告/追踪域名拦截 |

### 自定义规则

支持添加自定义域名或 IP：

```bash
# 域名格式
gemini.google.com
*.openai.com
domain:anthropic.com

# IP/CIDR 格式
1.1.1.1
10.0.0.0/8
192.168.1.0/24
```

### 规则优先级

分流规则按以下优先级匹配（从高到低）：
```
直连规则 > 自定义规则 > 预设规则 > 全局规则 (all)
```

### IPv4/IPv6 出站选择

添加规则时可选择仅使用 IPv6：
```
是否仅使用 IPv6? [y/N]: y
```

适用于 Netflix 等需要 IPv6 避免同户检测的场景。

### WARP 管理

WARP 是 Cloudflare 提供的免费 VPN 服务，脚本集成了 WARP 作为代理出口，可用于解锁流媒体、隐藏 VPS IP 等场景。

#### 功能入口

```bash
vless → 8) 分流管理 → 1) WARP 管理
```

#### WARP 管理菜单

```
═════════════════════════════════════════════
  WARP 管理
─────────────────────────────────────────────
  状态: ○ 未配置

  两种模式:
  • WGCF: UDP/WireGuard，性能好
  • 官方客户端: TCP/SOCKS5，绕过 UDP 封锁
─────────────────────────────────────────────
  1) 配置 WGCF 模式 (UDP/WireGuard)
  2) 配置官方客户端 (TCP/SOCKS5)
  0) 返回
─────────────────────────────────────────────
```

#### WARP 两种模式详解

| 模式 | 协议 | 特点 | 优势 | 劣势 |
|------|------|------|------|------|
| **WGCF** | UDP/WireGuard | Xray 内置支持 | 性能好、延迟低 | UDP 被封锁时无法使用 |
| **官方客户端** | TCP/SOCKS5 | warp-cli 官方工具 | 绕过 UDP 封锁 | 需要额外安装客户端 |

#### 第1步：选择 WARP 模式

根据你的网络环境选择合适的模式：

**如何判断 UDP 是否被封锁？**
- 如果 Hysteria2/TUIC 等 UDP 协议能正常使用 → 选择 WGCF
- 如果 UDP 协议无法连接 → 选择官方客户端

#### 第2步：配置 WGCF 模式

选择 `1) 配置 WGCF 模式`：

```
═════════════════════════════════════════════
  配置 WGCF 模式
─────────────────────────────────────────────
  ▸ 下载 wgcf 工具...
  ▸ 注册 WARP 账号...
  ▸ 生成 WireGuard 配置...
  ▸ 测试 IPv6 端点...
  
  ✓ WGCF 配置成功
  
  WARP 账户信息:
    账户类型: 免费版
    设备 ID: xxxxxxxx-xxxx-xxxx-xxxx
    
  出口 IP:
    IPv4: 104.28.xxx.xxx (Cloudflare)
    IPv6: 2606:4700:xxx::xxx
─────────────────────────────────────────────
```

**配置过程说明**：
1. 自动下载 `wgcf` 工具
2. 注册 Cloudflare WARP 账号
3. 生成 WireGuard 密钥对
4. 自动测试最佳 IPv6 端点
5. 保存配置到数据库

#### 第3步：配置官方客户端模式

如果 UDP 被封锁，选择 `2) 配置官方客户端`：

```
═════════════════════════════════════════════
  配置官方客户端
─────────────────────────────────────────────
  ▸ 安装 Cloudflare WARP 客户端...
  ▸ 注册 WARP 账号...
  ▸ 配置代理模式...
  ▸ 启动 warp-svc 服务...
  
  ✓ 官方客户端配置成功
  
  SOCKS5 代理地址: 127.0.0.1:40000
  
  出口 IP:
    IPv4: 104.28.xxx.xxx (Cloudflare)
─────────────────────────────────────────────
```

#### 第4步：测试 WARP 连接

配置完成后测试连接：

```
═════════════════════════════════════════════
  测试 WARP 连接
─────────────────────────────────────────────
  ▸ 测试 WARP 出口...
  
  ✓ 连接正常
  
  出口 IP 信息:
    IPv4: 104.28.247.156
    IPv6: 2606:4700:110:8f4a:xxx:xxx
    位置: 美国 洛杉矶
    运营商: Cloudflare, Inc.
    WARP: 已启用
─────────────────────────────────────────────
```

#### 第5步：在分流规则中使用 WARP

WARP 配置完成后，可在分流规则中选择 WARP 作为出口：

```
选择出口:
  1) 直连
  2) WARP        ← 选择这个
  3) Japan+04+Amazon (链式)
```

#### WARP 已启用状态菜单

```
═════════════════════════════════════════════
  WARP 管理
─────────────────────────────────────────────
  状态: ● 已连接
  模式: 官方客户端 (TCP/SOCKS5)
  代理: 127.0.0.1:40000
─────────────────────────────────────────────
  1) 切换模式 (WGCF ↔ 官方客户端)
  2) 重新连接
  3) 测试 WARP 连接
  4) 卸载 WARP
  0) 返回
─────────────────────────────────────────────
```

#### 切换 WARP 模式

选择 `1) 切换模式`：

```
═════════════════════════════════════════════
  切换 WARP 模式
─────────────────────────────────────────────
  当前模式: 官方客户端 (TCP/SOCKS5)
  
  确认切换到 WGCF 模式? [y/N]: y
  
  ▸ 停止官方客户端...
  ▸ 配置 WGCF...
  ▸ 更新 Xray 配置...
  
  ✓ 已切换到 WGCF 模式
─────────────────────────────────────────────
```

#### 重新连接 WARP

如果 WARP IP 被限制，可以重新连接获取新 IP：

```
═════════════════════════════════════════════
  重新连接 WARP
─────────────────────────────────────────────
  旧 IP: 104.28.247.156
  
  ▸ 重新连接中...
  
  ✓ 已获取新 IP
  
  新 IP: 104.28.192.23
─────────────────────────────────────────────
```

#### 卸载 WARP

选择 `4) 卸载 WARP`：

```
═════════════════════════════════════════════
  卸载 WARP
─────────────────────────────────────────────
  确认卸载 WARP? [y/N]: y
  
  ▸ 停止 WARP 服务...
  ▸ 删除配置文件...
  ▸ 更新 Xray 配置...
  
  ✓ WARP 已卸载
  
  提示: 使用 WARP 作为出口的分流规则需要重新配置
─────────────────────────────────────────────
```

#### WARP 常见问题

**Q: WGCF 模式连接失败怎么办？**

A: 可能是 UDP 被封锁，请切换到官方客户端模式。

**Q: WARP IP 被流媒体限制怎么办？**

A: 
1. 尝试"重新连接"获取新 IP
2. 使用"双层链式"(WARP → 落地节点)绕过限制

**Q: 如何确认 WARP 正在工作？**

A: 使用"测试 WARP 连接"功能，确认出口 IP 是 Cloudflare 的 IP

---

## 链式代理

### 功能入口

```bash
vless → 8) 分流管理 → 2) 链式代理
```

### 链式代理菜单

```
═════════════════════════════════════════════
  链式代理管理
─────────────────────────────────────────────
  状态: ● 分流已配置 (4 条规则)
  使用节点:
    • 🇯🇵Japan+04+Amazon ← tiktok
    • 🇸🇬Singapore+02+Amazon ← openai
  节点总数: 38
─────────────────────────────────────────────
  1) 添加节点 (分享链接)
  2) 导入订阅
  3) 一键导入 Alice SOCKS5 (8节点)
  4) WARP → 落地 (双层链式)
  5) 创建负载均衡组
  ───────────────────────────────────────────
  6) 测试所有节点延迟
  7) 删除节点
  8) 删除负载均衡组
  9) 禁用链式代理
  0) 返回
─────────────────────────────────────────────
```

### 添加节点

**方式一：分享链接**
```bash
1) 添加节点 (分享链接)
# 粘贴链接，如：
# vless://uuid@1.2.3.4:443?type=tcp&security=reality&...
```

**方式二：导入订阅**
```bash
2) 导入订阅
# 粘贴机场订阅链接
# 自动解析并预览节点
```

**导入订阅界面**：
```
═════════════════════════════════════════════
  导入订阅
─────────────────────────────────────────────
  输入订阅链接:
  URL: https://example.com/api/v1/subscribe

  ▸ 获取订阅内容...
─────────────────────────────────────────────
  ✓ 解析成功，共 22 个节点
─────────────────────────────────────────────
  协议统计:
    • vless: 22 个

  ▸ 检测节点延迟中...
  ▸ 检测中... (22/22)

  节点列表 (按延迟排序):
─────────────────────────────────────────────
  [8ms] 🇯🇵日本高速06 (BGP) (vless) 123.123.123.123
  [9ms] 🇭🇰香港高速03 (BGP) (vless) 123.123.123.123
  [10ms] 🇭🇰香港高速04 (BGP) (vless) 123.123.123.123
  [超时] 🇰🇷韩国高速01 (BGP) (vless) -
─────────────────────────────────────────────
  确认导入这 22 个节点? [Y/n]:
```

### 支持的节点类型

- ✅ VMess (含 WS/TLS)
- ✅ VLESS (含 Reality)
- ✅ Shadowsocks (SS2022/AEAD)
- ✅ Trojan
- ✅ Hysteria2
- ✅ SOCKS5

### 节点延迟测试

```bash
6) 测试所有节点延迟
```

```
═════════════════════════════════════════════
  测试节点延迟 (TCP连接延迟，仅供参考)
─────────────────────────────────────────────
  ▸ 检测 38 个节点延迟中... (并发 20)
  ✓ 延迟检测完成 (38 个节点)

  TCP延迟排序 (从低到高):
─────────────────────────────────────────────
  [9ms] 🇭🇰香港高速01 (vless) 123.123.123.123 ← openai
  [10ms] 🇯🇵日本高速02 (vless) 123.123.123.123 ← tiktok
  [15ms] 🇸🇬新加坡01 (vless) 123.123.123.123
  [223ms] v6节点 (shadowsocks) 2a0f:7803::1
  [超时] 🇹🇼台湾高速01 (BGP) (vless) -
─────────────────────────────────────────────
```

### 双层链式 (WARP → 落地)

双层链式是一种高级分流模式，通过 WARP 中转后再到落地节点，实现双重隐匿和解锁。

```bash
4) WARP → 落地 (双层链式)
```

#### 工作原理

```
用户请求 → VPS (入口)
              │
              ↓
         WARP 出口 (Cloudflare IP)
              │
              ↓
         落地节点 (解锁机)
              │
              ↓
         目标网站 (Netflix/ChatGPT等)
```

#### 为什么需要双层链式？

| 场景 | 问题 | 双层链式解决方案 |
|------|------|------------------|
| VPS IP 被识别 | 流媒体检测到机房 IP | 通过 WARP 隐藏 VPS IP |
| 落地机保护 | 不想暴露落地机 IP | 落地机只看到 WARP IP |
| 多重解锁 | 单节点无法解锁 | WARP + 落地双重解锁 |

#### 配置步骤

1. **启用 WARP**
   ```bash
   vless → 8) 分流管理 → 1) WARP 管理 → 2) 启用 WARP
   ```

2. **导入落地节点**
   ```bash
   vless → 8) 分流管理 → 2) 链式代理 → 1) 添加节点
   # 或 2) 导入订阅
   ```

3. **配置双层链式**
   ```bash
   vless → 8) 分流管理 → 2) 链式代理 → 4) WARP → 落地 (双层链式)
   ```

4. **选择落地节点**
   ```
   ═════════════════════════════════════════════
     WARP → 落地 (双层链式)
   ─────────────────────────────────────────────
     选择落地节点:
     
     1) 🇯🇵Japan+04+Amazon [延迟: 8ms]
     2) 🇸🇬Singapore+02+Amazon [延迟: 15ms]
     3) 🇭🇰Hong+Kong+04 [延迟: 12ms]
     0) 返回
   ─────────────────────────────────────────────
     请选择: 1
   ```

5. **配置分流规则**
   ```
   添加分流规则时选择双层链式出口:
   
   选择出口:
   1) 直连
   2) WARP
   3) Japan+04+Amazon (链式)
   4) 🔗 WARP→Japan+04 (双层)  ← 选择这个
   ```

#### 双层链式示例

```
═════════════════════════════════════════════
  分流规则
─────────────────────────────────────────────
  ● Netflix → 🔗 WARP→Japan+04 (双层链式)
  ● TikTok → 🔗 WARP→Japan+04 (双层链式)
  ● OpenAI → 🔗 WARP→Singapore+02 (双层链式)
─────────────────────────────────────────────
```

#### 优势总结

| 优势 | 说明 |
|------|------|
| **IP 隐匿** | 目标网站只能看到落地节点 IP |
| **VPS 保护** | VPS IP 不会被流媒体记录 |
| **落地保护** | 落地节点只看到 WARP IP |
| **解锁能力** | WARP 住宅 IP + 落地节点双重解锁 |
| **抗封锁** | WARP 作为中间层增强稳定性 |

---

## 负载均衡

### 创建负载均衡组

```bash
vless → 8) 分流管理 → 2) 链式代理 → 5) 创建负载均衡组
```

### 负载均衡策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| leastPing | 自动选择延迟最低的节点 | 追求速度 |
| random | 随机选择节点 | 分散流量 |
| roundRobin | 轮询使用节点 | 均衡负载 |

### 创建步骤

1. **选择策略**
   ```
   负载均衡策略:
   1. leastPing   (最低延迟 - 推荐)
   2. random      (随机选择)
   3. roundRobin  (轮询 - 流量均衡)
   0. 返回
   
   请选择策略: 1
   ```

2. **选择节点**
   ```
   选择节点:
   1. 使用所有节点 (推荐)
   2. 手动选择节点
   0. 返回
   
   请选择: 1
   ```

3. **输入组名**
   ```
   输入负载均衡组名称 (默认: 最低延迟组): 日本节点组
   ```

4. **创建成功**
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✓ 负载均衡组创建成功!
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   组名: 日本节点组
   策略: 最低延迟
   节点数: 8
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   下一步:
   1. 在 配置分流规则 中使用该负载均衡组
   2. 负载均衡组会自动管理节点切换
   ```

### 删除负载均衡组

```bash
8) 删除负载均衡组
```

```
═════════════════════════════════════════════
  删除负载均衡组
─────────────────────────────────────────────
  1) 日本节点组 (最低延迟, 8 节点)
  2) 香港节点组 (轮询, 5 节点)
─────────────────────────────────────────────
  输入 all 删除全部
  选择编号: 
```

---

## 多IP入出站配置

多IP入出站配置是专为拥有多个公网IP的服务器设计的功能。它可以让用户通过不同的入站IP连接时，流量从对应的出站IP发出，实现IP的精确控制。

### 功能作用

| 功能 | 说明 |
|------|------|
| **IP分离** | 不同入站IP的流量从不同出站IP发出 |
| **多线路** | 利用多IP实现多线路部署 |
| **负载分散** | 将流量分散到不同IP，避免单IP过载 |
| **地区解锁** | 不同IP可能对应不同地区/运营商 |

### 适用场景

- 🖥️ 多IP VPS（如拥有多个IPv4或IPv6地址）
- 🌐 多线路服务器（电信/联通/移动多线）
- 🔀 需要精确控制出站IP的高级用户

### 功能入口

```bash
vless → 8) 分流管理 → 11) 多IP入出站配置
```

### 管理菜单

根据当前状态，菜单会显示不同的选项：

**未启用状态**：
```
═════════════════════════════════════════════
  多IP入出站配置
─────────────────────────────────────────────
  状态: ● 已启用  规则数: 0
  检测到 2 个公网IP
─────────────────────────────────────────────
  系统公网IP:
    [1] 103.45.67.89 (未配置)
    [2] 2001:db8::2 (未配置)
─────────────────────────────────────────────
  1) 添加/修改映射规则
  2) 删除映射规则
  3) 清空所有规则
  4) 禁用多IP路由
  5) 应用配置到Xray
  0) 返回
─────────────────────────────────────────────
```

**界面说明**：

| 显示项 | 说明 |
|--------|------|
| **状态** | 显示功能是否已启用，以及当前规则数量 |
| **检测到的IP** | 系统自动检测的所有公网IP（包括IPv4和IPv6） |
| **未配置/已配置** | 显示每个IP是否已添加映射规则 |

**菜单选项说明**：

| 选项 | 功能 | 说明 |
|------|------|------|
| 1) 添加/修改映射规则 | 配置IP映射 | 指定入站IP对应的出站IP |
| 2) 删除映射规则 | 删除单条规则 | 移除已配置的映射 |
| 3) 清空所有规则 | 清除全部规则 | 重置为默认状态 |
| 4) 禁用/启用多IP路由 | 切换功能状态 | 不删除规则，仅启用/禁用 |
| 5) 应用配置到Xray | 更新Xray配置 | 手动应用配置更改 |

### 什么是"启用多IP路由"？

**启用多IP路由**意味着：
1. **激活功能** - 让配置的IP映射规则生效
2. **生成配置** - 自动在Xray配置中生成对应的outbound和routing规则
3. **应用规则** - 重启Xray服务使配置生效

**禁用多IP路由**意味着：
1. **暂停功能** - 停止使用IP映射规则
2. **保留规则** - 已配置的规则不会被删除，只是暂时不生效
3. **恢复默认** - Xray使用默认的出站IP

**简单理解**：
- 启用 = 开关打开，按照你配置的规则走
- 禁用 = 开关关闭，规则保留但不生效

### 详细操作步骤

#### 第1步：进入管理菜单

1. 运行 `vless` 命令进入主菜单
2. 选择 `8) 分流管理`
3. 选择 `2) 链式代理`
4. 选择 `5) 多IP入出站配置`

#### 第2步：查看检测到的IP

进入菜单后，脚本会自动检测服务器的所有公网IP：

```
═════════════════════════════════════════════
  多IP入出站配置
─────────────────────────────────────────────
  状态: ○ 未启用

  检测到的公网IP:
    IPv4: 103.45.67.89, 103.45.67.90, 103.45.67.91
    IPv6: 2001:db8::1, 2001:db8::2
─────────────────────────────────────────────
```

> **提示**：如果IP检测不完整，可能是部分IP未绑定到网卡或配置为别名。

#### 第3步：添加映射规则

1. 选择 `1) 添加/修改映射规则`
2. 从列表中选择IP：

```
═════════════════════════════════════════════
  添加映射规则
─────────────────────────────────────────────
  可用IP列表:
    [1] 103.45.67.89
    [2] 103.45.67.90
    [3] 103.45.67.91
    [4] 2001:db8::1
    [5] 2001:db8::2

  选择入站IP编号: 1
  选择出站IP编号: 1 (回车使用相同IP)

  ✓ 规则添加成功
    入站: 103.45.67.89 → 出站: 103.45.67.89
─────────────────────────────────────────────
```

**参数说明**：

| 参数 | 说明 | 示例 |
|------|------|------|
| **入站IP** | 用户连接代理时使用的服务器IP | `103.45.67.89` |
| **出站IP** | 该用户的流量从哪个IP发出 | `103.45.67.89` |

**常见配置方式**：

| 方式 | 入站IP | 出站IP | 用途 |
|------|--------|--------|------|
| 同IP对应 | 103.45.67.89 | 103.45.67.89 | 保持入出一致 |
| 同IP对应 | 103.45.67.90 | 103.45.67.90 | 保持入出一致 |
| 跨IP映射 | 103.45.67.89 | 103.45.67.91 | 入站A从B发出 |

#### 第4步：添加更多规则

重复第3步，为每个需要配置的IP添加规则：

```
  已配置规则:
    1. 103.45.67.89 → 103.45.67.89
    2. 103.45.67.90 → 103.45.67.90
    3. 103.45.67.91 → 103.45.67.91
```

#### 第5步：查看当前规则

选择 `1) 查看当前规则`：

```
═════════════════════════════════════════════
  当前IP路由规则
─────────────────────────────────────────────
  状态: ● 已启用

  规则列表:
    [1] 入站: 103.45.67.89 → 出站: 103.45.67.89
    [2] 入站: 103.45.67.90 → 出站: 103.45.67.90
    [3] 入站: 103.45.67.91 → 出站: 103.45.67.91
─────────────────────────────────────────────
```

#### 第6步：启用多IP路由

选择 `4) 启用多IP路由`：

```
═════════════════════════════════════════════
  启用多IP路由
─────────────────────────────────────────────
  ▸ 正在生成配置...
  ▸ 重启 Xray 服务...
  
  ✓ 多IP路由已启用
  
  当前规则:
    103.45.67.89 → 103.45.67.89
    103.45.67.90 → 103.45.67.90
    103.45.67.91 → 103.45.67.91
─────────────────────────────────────────────
```

### 删除规则

选择 `3) 删除映射规则`：

```
═════════════════════════════════════════════
  删除IP映射规则
─────────────────────────────────────────────
  当前规则:
    1) 入站: 103.45.67.89 → 出站: 103.45.67.89
    2) 入站: 103.45.67.90 → 出站: 103.45.67.90
    3) 入站: 103.45.67.91 → 出站: 103.45.67.91

  输入序号删除 (0 返回): 2

  ✓ 规则已删除
─────────────────────────────────────────────
```

### 禁用功能

选择 `5) 禁用多IP路由`：

```
═════════════════════════════════════════════
  禁用多IP路由
─────────────────────────────────────────────
  ▸ 正在更新配置...
  ▸ 重启 Xray 服务...
  
  ✓ 多IP路由已禁用
  
  提示: 规则已保留，可随时重新启用
─────────────────────────────────────────────
```

### 技术原理

启用后，Xray 配置会自动生成：

1. **Outbound（出站）**：为每个出站IP创建带 `sendThrough` 的 freedom 出口
2. **Routing（路由）**：根据 `inboundTag` 匹配入站IP，路由到对应出站

**生成的配置示例**：

```json
{
  "outbounds": [
    {
      "tag": "direct-ip-103-45-67-89",
      "protocol": "freedom",
      "sendThrough": "103.45.67.89"
    },
    {
      "tag": "direct-ip-103-45-67-90",
      "protocol": "freedom",
      "sendThrough": "103.45.67.90"
    }
  ],
  "routing": {
    "rules": [
      {
        "type": "field",
        "inboundTag": ["ip-in-103-45-67-89"],
        "outboundTag": "direct-ip-103-45-67-89"
      },
      {
        "type": "field",
        "inboundTag": ["ip-in-103-45-67-90"],
        "outboundTag": "direct-ip-103-45-67-90"
      }
    ]
  }
}
```

### 注意事项

| 注意点 | 说明 |
|--------|------|
| **IP必须可用** | 入站和出站IP必须是服务器实际拥有的公网IP |
| **协议支持** | 目前支持所有 Xray 核心协议 |
| **优先级** | 多IP路由规则优先于其他分流规则 |
| **重启生效** | 配置更改后服务会自动重启 |

### 常见问题

**Q: 为什么检测不到我的IP？**

A: 检查IP是否已绑定到网卡。使用 `ip addr` 命令查看。

**Q: 配置后不生效怎么办？**

A: 
1. 确认功能已启用（状态显示"已启用"）
2. 检查 Xray 服务是否正常运行
3. 查看 Xray 日志确认配置是否正确

**Q: 可以配置IPv6吗？**

A: 可以，脚本同时支持IPv4和IPv6地址的映射配置。

---

## CF Tunnel(Argo)

CF Tunnel (即 Cloudflare Tunnel，旧称 Argo Tunnel) 是 Cloudflare 提供的内网穿透服务，可以让没有公网 IP 的机器也能对外提供服务。

### 功能入口

```bash
vless → 9) CF Tunnel(Argo)
```

### Tunnel 菜单

```
═════════════════════════════════════════════
  CF Tunnel(Argo) 内网穿透
─────────────────────────────────────────────
  cloudflared: ● 已安装
  隧道状态: ● 运行中
  隧道名称: my-tunnel
  协议数量: 2
─────────────────────────────────────────────
  1) 安装/更新 cloudflared
  2) 登录 Cloudflare
  3) 创建隧道
  4) 添加协议到隧道
  5) 快速隧道 (临时域名)
  ───────────────────────────────────────────
  6) 查看隧道状态
  7) 删除隧道
  8) 卸载 cloudflared
  0) 返回
─────────────────────────────────────────────
```

### 适用场景

| 场景 | 说明 | 示例 |
|------|------|------|
| **NAT 机器** | 无公网 IP 的 VPS | NAT VPS、家庭服务器 |
| **动态 IP** | IP 会变化的网络 | 家庭宽带、移动网络 |
| **隐藏 IP** | 不想暴露真实 IP | 高安全需求场景 |
| **端口受限** | 服务商只开放特定端口 | 只有 80/443 端口 |

### 隧道类型对比

| 类型 | 域名 | 认证 | 有效期 | 适用场景 |
|------|------|------|--------|----------|
| **快速隧道** | xxx.trycloudflare.com | 不需要 | 临时 | 测试、临时使用 |
| **命名隧道** | 自定义域名 | 需要 OAuth | 永久 | 生产环境 |

### 支持的协议

| 协议 | 支持 | 说明 |
|------|:----:|------|
| **VLESS-WS (无TLS)** | ✅ | 推荐，由 CF Tunnel 提供 TLS |
| VLESS-WS | ✅ | WebSocket 可穿透 CDN |
| VMess-WS | ✅ | WebSocket 可穿透 CDN |
| Hysteria2/TUIC | ❌ | UDP 协议不支持 |
| Reality | ❌ | SNI 伪装与 CF TLS 冲突 |

> 💡 **推荐使用 VLESS-WS（无TLS）**：安装时选择「VLESS-WS-CF (无TLS)」，无需申请证书，CF Tunnel 自动提供 TLS 加密。

### 完整使用流程

#### 1. 安装 cloudflared

```bash
1) 安装/更新 cloudflared
```

```
═════════════════════════════════════════════
  安装 cloudflared
─────────────────────────────────────────────
  ▸ 检测系统架构... amd64
  ▸ 下载 cloudflared...
  ▸ 安装到 /usr/local/bin/cloudflared
  ✓ 安装成功
  
  版本: 2024.1.5
─────────────────────────────────────────────
```

#### 2. 登录 Cloudflare（命名隧道需要）

```bash
2) 登录 Cloudflare
```

```
═════════════════════════════════════════════
  登录 Cloudflare
─────────────────────────────────────────────
  请在浏览器中打开以下链接完成认证:
  
  https://dash.cloudflare.com/argotunnel
  
  等待认证中...
─────────────────────────────────────────────
  ✓ 认证成功
  账户: your-email@example.com
  证书保存: ~/.cloudflared/cert.pem
─────────────────────────────────────────────
```

#### 3. 创建隧道

```bash
3) 创建隧道
```

```
═════════════════════════════════════════════
  创建隧道
─────────────────────────────────────────────
  输入隧道名称: my-proxy-tunnel
  
  ▸ 创建隧道中...
  ✓ 隧道创建成功
  
  隧道 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  隧道名称: my-proxy-tunnel
─────────────────────────────────────────────
```

#### 4. 添加协议到隧道

```bash
4) 添加协议到隧道
```

```
═════════════════════════════════════════════
  添加协议到隧道
─────────────────────────────────────────────
  选择要添加的协议:
  
  1) VLESS-WS (443)
  2) VMess-WS (443)
  0) 返回
─────────────────────────────────────────────
  请选择: 1

  输入绑定域名: proxy.example.com
  
  是否将监听改为 127.0.0.1? [y/N]: y
  (仅通过隧道访问，更安全)
  
  ▸ 配置隧道路由...
  ✓ 协议添加成功
  
  域名: proxy.example.com
  协议: VLESS-WS
  
  请添加 DNS 记录:
  proxy.example.com CNAME xxxxxxxx.cfargotunnel.com
─────────────────────────────────────────────
```

#### 5. 配置 DNS

**方式一：自动配置（需要 API Token）**
```
是否自动配置 DNS? [Y/n]: y
输入 Zone ID: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
输入 API Token: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

✓ DNS 记录已添加
```

**方式二：手动配置**
```
请在 Cloudflare DNS 管理页面添加:

类型: CNAME
名称: proxy
内容: xxxxxxxx.cfargotunnel.com
代理状态: 已代理 (橙色云朵)
```

### 快速隧道

无需登录认证，立即获得临时地址，适合测试使用：

```bash
5) 快速隧道 (临时域名)
```

```
═════════════════════════════════════════════
  快速隧道
─────────────────────────────────────────────
  选择协议:
  
  1) VLESS-WS (443)
  2) VMess-WS (443)
─────────────────────────────────────────────
  请选择: 1
  
  ▸ 启动快速隧道...
  ✓ 隧道启动成功

  临时域名: abc-xyz-123.trycloudflare.com
  协议: VLESS-WS
  
  分享链接:
  vless://uuid@abc-xyz-123.trycloudflare.com:443?...
  
  二维码:
  ████████████████████
  ██  ██  ██  ██  ██
  ████████████████████
─────────────────────────────────────────────
  ⚠ 临时域名会在隧道关闭后失效
  ⚠ 重启后会获得新的临时域名
─────────────────────────────────────────────
```

### 安全选项

添加协议时可选择将监听地址改为 `127.0.0.1`：

| 选项 | 监听 0.0.0.0 | 监听 127.0.0.1 |
|------|-------------|----------------|
| 直接 IP 访问 | ✅ 可以 | ❌ 不可以 |
| 隧道访问 | ✅ 可以 | ✅ 可以 |
| 安全性 | 一般 | 更高 |
| 隧道关闭后 | 仍可访问 | 无法访问 |

**推荐**：生产环境使用 `127.0.0.1` 以提高安全性。

### 常见问题

#### 隧道连接失败

```bash
# 检查 cloudflared 服务状态
systemctl status cloudflared

# 查看日志
journalctl -u cloudflared -n 50
```

#### 域名无法访问

1. 检查 DNS 记录是否正确
2. 确认 Cloudflare 代理已开启（橙色云朵）
3. 检查 SSL/TLS 设置为「完全」或「完全（严格）」

#### VLESS-WS-CF 使用 443 端口连不上

这是正确的行为，需要检查：

1. **检查 xray 服务**：
   ```bash
   systemctl status vless-reality
   ```

2. **检查本地端口监听**：
   ```bash
   ss -tlnp | grep 18443  # 你配置的端口
   ```

3. **检查 cloudflared 服务**：
   ```bash
   systemctl status cloudflared
   journalctl -u cloudflared -n 30
   ```

4. **客户端配置**：
   | 参数 | 正确值 |
   |------|--------|
   | 地址 | 你的 CF 域名 |
   | 端口 | **443**（不是 18443）|
   | TLS | **开启** |
   | SNI/Host | 你的 CF 域名 |

#### 在哪里查看 VLESS-WS-CF 的分享链接

进入 `vless → 9) CF Tunnel(Argo) → 6) 查看隧道状态`，会显示分享链接和二维码。

### 查看隧道状态

选择 `6) 查看隧道状态`：

```
═════════════════════════════════════════════
  隧道状态
─────────────────────────────────────────────
  隧道名称: my-proxy-tunnel
  隧道 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  状态: ● 运行中
  
  已配置的路由:
    1) proxy.example.com → VLESS-WS (127.0.0.1:443)
    2) ws.example.com → VMess-WS (127.0.0.1:443)
  
  服务信息:
    进程 PID: 12345
    运行时间: 2 天 5 小时
    连接数: 3
─────────────────────────────────────────────
```

### 启动/停止隧道服务

选择 `7) 启动/停止服务`：

```
═════════════════════════════════════════════
  隧道服务控制
─────────────────────────────────────────────
  当前状态: ● 运行中
  
  1) 停止隧道服务
  2) 重启隧道服务
  0) 返回
─────────────────────────────────────────────
  请选择: 1
  
  ▸ 停止隧道服务...
  ✓ 服务已停止
─────────────────────────────────────────────
```

### 删除隧道

选择 `8) 删除隧道`：

```
═════════════════════════════════════════════
  删除隧道
─────────────────────────────────────────────
  隧道名称: my-proxy-tunnel
  
  ⚠ 警告: 删除隧道将导致所有已配置的域名无法访问！
  
  确认删除? [y/N]: y
  
  ▸ 停止隧道服务...
  ▸ 删除 DNS 记录...
  ▸ 删除隧道配置...
  
  ✓ 隧道已删除
  
  提示: 如需重新使用，请重新创建隧道
─────────────────────────────────────────────
```

### 卸载 cloudflared

选择 `9) 卸载 cloudflared`：

```
═════════════════════════════════════════════
  卸载 cloudflared
─────────────────────────────────────────────
  ⚠ 警告: 这将完全卸载 cloudflared 及所有隧道配置！
  
  确认卸载? [y/N]: y
  
  ▸ 停止所有隧道...
  ▸ 删除隧道配置...
  ▸ 删除 cloudflared 程序...
  ▸ 清理缓存和证书...
  
  ✓ cloudflared 已完全卸载
─────────────────────────────────────────────
```

### 完整使用示例：NAT VPS 配置

以下是在没有公网 IP 的 NAT VPS 上配置代理的完整流程：

**场景**：你有一台 NAT VPS，没有独立公网 IP，但想使用它作为代理服务器。

**前提条件**：
- 一个托管在 Cloudflare 的域名
- Cloudflare 账户

**步骤**：

1. **安装 cloudflared**
   ```
   vless → 9) Cloudflare Tunnel → 1) 安装 cloudflared
   ```

2. **登录 Cloudflare**
   ```
   2) 登录 Cloudflare
   → 在浏览器中打开给出的链接
   → 选择你的域名所在的账户
   → 完成授权
   ```

3. **安装 VLESS-WS 协议**
   ```
   vless → 1) 安装新协议 → VLESS-WS
   → 端口: 443
   → 等待安装完成
   ```

4. **创建隧道**
   ```
   vless → 9) Cloudflare Tunnel → 3) 创建隧道
   → 输入隧道名称: my-nat-tunnel
   ```

5. **添加协议到隧道**
   ```
   4) 添加协议到隧道
   → 选择 VLESS-WS
   → 输入域名: proxy.yourdomain.com
   → 是否监听 127.0.0.1: y (推荐)
   ```

6. **配置 DNS**
   ```
   在 Cloudflare 控制台添加 CNAME 记录:
   名称: proxy
   目标: xxxxxxxx.cfargotunnel.com
   代理状态: 已代理
   ```

7. **获取分享链接**
   ```
   vless → 5) 查看协议配置 → VLESS-WS
   → 复制分享链接，使用域名 proxy.yourdomain.com
   ```

**最终效果**：
- 用户通过 `proxy.yourdomain.com:443` 连接代理
- 流量: 用户 → Cloudflare CDN → 隧道 → NAT VPS → 目标网站
- NAT VPS 的真实 IP 完全隐藏

### Cloudflare Tunnel 常见问题汇总

**Q: 快速隧道和命名隧道有什么区别？**

| 对比项 | 快速隧道 | 命名隧道 |
|--------|----------|----------|
| 域名 | 随机临时域名 | 自定义域名 |
| 有效期 | 重启后失效 | 永久有效 |
| 需要登录 | 不需要 | 需要 OAuth |
| 适用场景 | 临时测试 | 生产环境 |

**Q: 隧道重启后域名变了怎么办？**

A: 使用命名隧道而不是快速隧道，命名隧道的域名是固定的。

**Q: 可以同时暴露多个协议吗？**

A: 可以，只需多次"添加协议到隧道"，使用不同的子域名。

**Q: 隧道影响速度吗？**

A: 会有一定延迟增加（经过 Cloudflare CDN），但通常可接受。优势是更好的隐私保护和 CDN 加速。

---

## 订阅服务

### 功能入口

```bash
vless → 6) 订阅服务管理
```

### 订阅服务菜单

```
═════════════════════════════════════════════
  订阅服务管理
─────────────────────────────────────────────
  状态: 已配置
  端口: 8443
  域名: example.com
  HTTPS: true
─────────────────────────────────────────────
  1) 查看订阅链接
  2) 更新订阅内容
  3) 外部节点管理
  4) 重新配置
  5) 停用订阅服务
  0) 返回
─────────────────────────────────────────────
```

### 订阅链接格式

```
https://example.com:8443/sub/{UUID}/clash   # Clash/Clash Verge
https://example.com:8443/sub/{UUID}/surge   # Surge
https://example.com:8443/sub/{UUID}/v2ray   # V2Ray/Loon/通用
```

### 订阅特性

| 特性 | 说明 |
|------|------|
| 自动更新 | 安装/卸载协议后自动更新订阅内容 |
| HTTPS 加密 | 使用 Nginx + 证书加密传输 |
| 伪装网页 | 访问根路径显示正常网站 |
| 随机路径 | UUID 路径防止被扫描 |
| 外部节点 | 支持聚合多台服务器节点 |

### 外部节点管理

将其他服务器的节点聚合到同一订阅：

```bash
3) 外部节点管理
```

```
  1) 添加分享链接      # 单个节点链接
  2) 添加订阅链接      # 机场订阅
  3) 查看外部节点
  4) 删除外部节点
  5) 刷新订阅          # 重新拉取订阅
```

### 一键展示所有分享链接

快速获取所有已安装协议的分享链接：

```bash
vless → 5) 查看协议配置 → a) 一键展示所有分享链接
```

---

## 端口复用

### 工作原理

```
客户端 → 443 端口 → VLESS-Vision/Trojan (TLS主协议)
                          ↓ 回落
                     VLESS-WS (子协议，监听 127.0.0.1)
                     VMess-WS (子协议，监听 127.0.0.1)
```

### 使用方法

1. **先安装 TLS 主协议**
   - VLESS-Vision
   - Trojan

2. **再安装回落子协议**
   - VLESS-WS
   - VMess-WS

3. 子协议自动识别为回落模式

### 优势

| 优势 | 说明 |
|------|------|
| 端口隐蔽 | 只需开放 443 端口 |
| 流量伪装 | 流量特征像正常 HTTPS |
| 多协议 | 多协议共用一个端口 |

---

## 端口跳跃

### 适用协议

- Hysteria2
- TUIC v5

### 工作原理

```
客户端 → 随机端口 (20000-50000) → iptables NAT → 实际端口 (15999)
```

### 安装时配置

```
是否启用端口跳跃? [y/N]: y
起始端口 [回车默认 20000]: 20000
结束端口 [回车默认 50000]: 50000
```

### 客户端配置

将端口改为范围格式：
```
原端口: 15999
改为: 20000-50000
```

### 查看 iptables 规则

```bash
iptables -t nat -L PREROUTING -n | grep REDIRECT
```

---

## BBR 优化

### 功能入口

```bash
vless → 10) BBR 网络优化
```

### 智能参数配置

自动根据服务器内存选择最佳档位：

| 档位 | 内存范围 | 读写缓冲区 | 最大连接队列 | 文件句柄 |
|------|----------|-----------|-------------|---------|
| 经典级 | ≤512MB | 8MB | 32768 | 262144 |
| 轻量级 | 512MB-1GB | 16MB | 49152 | 524288 |
| 标准级 | 1GB-2GB | 32MB | 65535 | 1048576 |
| 高性能级 | 2GB-4GB | 64MB | 65535 | 2097152 |
| 企业级 | 4GB-8GB | 128MB | 65535 | 4194304 |
| 旗舰级 | >8GB | 128MB | 65535 | 8388608 |

### BBR 菜单

```
═════════════════════════════════════════════
  BBR 网络优化
─────────────────────────────────────────────
  系统信息
  内核版本: 6.1.0-39-cloud-amd64 ✓
  内存大小: 2048MB
  CPU核心数: 2
  虚拟化类型: kvm
─────────────────────────────────────────────
  当前状态
  拥塞控制: bbr
  队列调度: fq

  已配置参数
  读缓冲区: 32MB
  写缓冲区: 32MB
  最大连接队列: 65535
  最大文件句柄: 1048576
─────────────────────────────────────────────
  ✓ BBR 已启用

  1) 重新优化 (更新参数)
  2) 卸载 BBR 优化
  0) 返回
─────────────────────────────────────────────
```

### 优化效果

- ✅ 提升 TCP 传输速度
- ✅ 降低网络延迟
- ✅ 改善高丢包环境下的传输质量
- ✅ 自动检测内核版本和系统配置
- ✅ 支持重新优化和卸载

---

## 配置管理

### 功能入口

```bash
vless → 5) 查看协议配置 → 配置管理
```

### 导出配置

一键备份所有配置到 JSON 文件：
- 所有已安装协议的配置参数
- 分流规则 (WARP/链式代理)
- 链式代理节点列表
- 外部节点配置

备份文件保存在 `/etc/vless-reality/backup/` 目录。

### 导入配置

支持两种导入方式：
- **全部导入** - 恢复所有配置
- **选择性导入** - 只导入协议配置 / 分流规则 / 外部节点

### 自动更新 IP

服务器 IP 变化后，自动更新所有配置中的 IP 地址：
- 检测当前服务器 IPv4/IPv6
- 更新数据库中的 IP 记录
- 重新生成订阅文件
- 重新生成分享链接

---

## 文件位置

```
/etc/vless-reality/
├── config.json           # Xray 主配置文件
├── singbox.json          # Sing-box 配置文件
├── db.json               # JSON 数据库 (协议配置、分流规则、节点)
├── warp.json             # WGCF 配置文件
├── sub.info              # 订阅服务配置
├── external_links.txt    # 外部节点分享链接
├── external_subs.txt     # 外部节点订阅链接
├── subscription/         # 订阅文件目录
│   └── {uuid}/
│       ├── clash.yaml
│       ├── surge.conf
│       └── base64
├── external_nodes_cache/ # 外部节点缓存
├── certs/                # 证书目录
├── backup/               # 配置备份目录
└── logs/                 # 日志目录
```

---

## 常见问题

### 订阅链接 404

**问题**：访问订阅链接返回 404

**解决方案**：
1. 检查 Nginx 是否运行：`ss -tlnp | grep 8443`
2. 检查订阅文件是否存在：`ls /etc/vless-reality/subscription/`
3. 重新配置订阅

### Clash 导入超时

**问题**：Clash 导入订阅超时

**解决方案**：
1. 确认回落子协议使用 443 端口
2. 检查证书是否有效
3. 刷新订阅内容：`vless → 6) 订阅服务管理 → 2) 更新订阅内容`

### TUN 模式启动失败

**问题**：客户端 TUN 模式无法启动

**解决方案**：
- LXC 容器不支持 TUN，使用 SOCKS5 模式
- 检查 TUN 设备：`ls -la /dev/net/tun`

### Hysteria2/TUIC 端口跳跃不生效

**问题**：端口跳跃配置后不生效

**解决方案**：
1. 检查 iptables 规则：`iptables -t nat -L PREROUTING -n | grep REDIRECT`
2. NAT 机器不支持端口跳跃（服务商只给固定端口）
3. 确认客户端端口格式正确（范围格式如 `20000-50000`）

### WARP 官方客户端注册失败

**问题**：WARP 官方客户端无法注册

**解决方案**：
- Alpine 系统不支持官方客户端，请使用 WGCF 模式
- 检查 warp-svc 服务：`systemctl status warp-svc`

### WARP 分流不生效

**问题**：配置了 WARP 分流但不生效

**解决方案**：
1. 检查 WARP 状态：分流管理 → WARP 管理 → 测试连接
2. 确认分流规则已配置：分流管理 → 查看当前配置

### Xray 启动失败

**问题**：Xray 服务无法启动

**解决方案**：
1. 查看错误日志：`journalctl -u xray -n 50`
2. 检查配置文件：`xray run -test -c /etc/vless-reality/config.json`
3. 常见错误：
   - 端口被占用
   - 证书路径错误
   - JSON 配置格式错误

---

## 更多帮助

- 📖 [README](README.md) - 项目概览
- 📝 [CHANGELOG](CHANGELOG.md) - 更新日志
- 💬 [Telegram 群](https://t.me/vless_vaio) - 交流讨论
